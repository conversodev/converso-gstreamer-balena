# gstreamer-playground

Balena-based gstreamer debug and profiling setup

`gstreamer` is incredibly powerful but notoriously hard to learn, use and debug.

This project aim is to help debug and profile gstreamer pipeline.

This is a work in progress

## Architecture

This should run on either ARMv7, ARM64 and x86 architecture.

## What's inside ?

- `ubuntu`
- `gstreamer`
- `gstreamer-plugins-good`
- `gstreamer-plugins-bad`
- `gstreamer-plugins-ugly`
- `gst-shark`
- `graphviz`
- `v4l-utils`
- `mkvtoolnix`
- `alsa`
- `xserver` ([balenablocks/xserver](https://hub.balena.io/balenablocks/xserver))
- `files` ([edwin3/files](https://hub.balena.io/edwin3/files))

## Running a pipe using `gst-launch`

Connect using `ssh` (either thru balena cli or cloud) into the service.

Use `gst-launch-1.0 -ve YOUR ! TEST ! PIPE`. Let it run as long as you need, press `CTRL+C` to interupt it.

## Log level

Log level is set to 3 (FIXME) by default.
You can change it to any level using the `GST_DEBUG` environment variable (in docker-compose.yml, balena cloud, or in the running container).

Valid Levels are 0 to 9, check the [`gstreamer` doc](https://gstreamer.freedesktop.org/documentation/tutorials/basic/debugging-tools.html?gi-language=c) for more infos.

## Visualizing a pipeline

Thanks to `GST_DEBUG_DUMP_DOT_DIR` env var set in docker-compose.yml, `gstreamer` will output a `dot` file at each change of pipeline status. (PREROLL, RUNNING, ...).

Those `dot` files are stored in `/files/dots` which are served on port 80 by `edwin3/files` block.

You can turn those to `png` or `pdf` with the following command :

`dot -Tpng /files/dots/DOT_FILE_OF_INTEREST.dot > /files/pipeline.png`

or

`dot -Tpdf /files/dots/DOT_FILE_OF_INTEREST.dot > /files/pipeline.pdf`

## Accessing files

You can access the files (dot, png, pdf, ...) using the files webserver.

Everything you put inside `/files` will be available at `http://ip_of_your_device` (or `http://short_hash_of_your_device.local`)

You can also activate the `public url` in balenacloud and access those thru there.

## Using GSTShark

`Gstshark` is a profiling tool for your `gstreamer` pipeline. It's made by great folks at [https://ridgerun.com](Ridgerun).

[The doc of the tool is on their wiki](https://developer.ridgerun.com/wiki/index.php?title=GstShark), be sure to read it.

At the time of writing, GSTShark includes 9 tracers :

- `InterLatency` : Measures the latency time at different points in the pipeline.
- `ProcTime` : Measures the time an element takes to produce an output given the corresponding input.
- `Framerate` : Measures the amount of frames that go through a src pad every second.
- `ScheduleTime` : Measures the amount of time between two consecutive buffers in a sink pad.
- `CPUUsage` : Measures the CPU usage every second. In multiprocessor systems this measurements are presented per core.
- `Graphic` : Records a graphical representation of the current pipeline.
- `Bitrate` : Measures the current stream bitrate in bits per second.
- `Queue` Level : Measures the amount of data queued in every queue element in the pipeline.
- `Buffer` : Prints information of every buffer that passes through every sink pad in the pipeline. This information contains PTS and DTS, duration, size, flags and even refcount.

To activate GSTShark, you need to set a few vars in the environment (again using docker-compose, balenacloud or directly on the device) :

- `GST_DEBUG="GST_TRACER:7"`
- `GST_TRACERS="cpuusage"`
- `GST_SHARK_LOCATION=/files/traces` (set by default)

You can choose multiple tracerÂ at the same time if you like, just separate them with ';' (ie. `"queue;framerate"`)

There's other options you can set if needed, refer to the GSTShark doc for more infos.

Tracers accepts parameters using this synthax : `GST_TRACERS="tracer(parameter=value)"`
The list of paramters for each tracer is in [the official doc](https://developer.ridgerun.com/wiki/index.php/GstShark_-_Tracers)

### Parsing traces to generate graphs

To make sense of the traces files generated by GSTShark, the easiest way it to plot them on a graph.

To do so GSTShark comes with a dedicated tool called `gstshark-plot`.

It's available in `/gst-shark/scripts/graphics/gstshark-plot`.

Usage is : `cd /files/traces && ./gst-shark/scripts/graphics/gstshark-plot /files/traces -s pdf -l outside`

You can change the output format to `png` by replacing `pdf`, and choose another place for the legends (`inside`, `outside` or `extern`).

# TODO and next steps for this project

- [ ] adding some automation to the creation of images and plots from raw dot and traces files
- [ ] accepting a pipeline as an ENV var
- [ ] accepting a time limit to run the pipeline as ENV var
- [ ] making a webpage with options to run an arbitrary pipe and get the resulting visualizations and graphs
- [ ] build a living library of useful pipelines
